{% load static %}
<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Qu·∫£n L√Ω S·∫£n Ph·∫©m ‚Äì Zascapay</title>
    <link rel="icon" href="{% static 'images/header-gem.svg' %}">
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
</head>
<body class="antialiased bg-slate-50 text-slate-700">
<div class="min-h-screen">
    <!-- Sidebar -->
    <aside class="hidden md:flex md:flex-col fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200/70">
        <div class="h-16 px-5 flex items-center gap-2 border-b border-slate-200/70">
            <img class="h-7 w-7" src="{% static 'images/header-gem.svg' %}" alt="Zascapay"/>
            <span class="font-semibold text-gem-dark">Zascapay</span>
        </div>
        <nav class="p-3 text-sm">
            <a href="/" class="flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-slate-100">
                <span class="i">üè†</span>
                <span>T·ªïng Quan</span>
            </a>
            <a href="{% url 'product_list' %}" class="mt-1 flex items-center gap-3 rounded-lg px-3 py-2 bg-orange-600 text-white">
                <span class="i">üì¶</span>
                <span>S·∫£n Ph·∫©m</span>
            </a>
            <a href="#" class="mt-1 flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-slate-100">
                <span class="i">üë•</span>
                <span>Kh√°ch H√†ng</span>
            </a>
            <a href="#" class="mt-1 flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-slate-100">
                <span class="i">üìà</span>
                <span>Ph√¢n T√≠ch B√°n H√†ng</span>
            </a>
            <a href="#" class="mt-1 flex items-center gap-3 rounded-lg px-3 py-2 hover:bg-slate-100">
                <span class="i">‚öôÔ∏è</span>
                <span>C√†i ƒê·∫∑t v√† B·∫£o M·∫≠t</span>
            </a>
        </nav>
    </aside>

    <!-- Main -->
    <main class="md:ml-64">
        <!-- Top bar -->
        <div class="h-16 bg-white border-b border-slate-200/70 flex items-center">
            <div class="w-full container mx-auto px-4 flex items-center justify-between">
                <h1 class="text-lg font-semibold">Qu·∫£n L√Ω S·∫£n Ph·∫©m</h1>
                <div class="flex items-center gap-3">
                    <button id="exportBtn" class="px-3 py-2 rounded-lg border border-slate-200/70 bg-white hover:bg-slate-50 text-sm">Xu·∫•t D·ªØ Li·ªáu</button>
                    <button id="openCreateBtn" class="px-3 py-2 rounded-lg bg-orange-600 text-white hover:bg-orange-700 text-sm">+ Th√™m S·∫£n Ph·∫©m</button>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-6">
            <p class="text-slate-500">Qu·∫£n l√Ω danh m·ª•c s·∫£n ph·∫©m v√† hi·ªáu su·∫•t ph√°t hi·ªán</p>

            <!-- Filters -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
                <div class="relative">
                    <input id="searchInput" type="text" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="w-full rounded-lg border border-slate-300 px-4 py-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-gem-mid"/>
                    <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.3-4.3"/></svg>
                </div>
                <select id="categoryFilter" class="rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-gem-mid">
                    <option value="">T·∫•t C·∫£ Danh M·ª•c</option>
                </select>
                <div class="flex items-center gap-2">
                    <select id="statusFilter" class="w-full rounded-lg border border-slate-300 px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-gem-mid">
                        <option value="">T·∫•t C·∫£ Tr·∫°ng Th√°i</option>
                        <option value="active">Ho·∫°t ƒê·ªông</option>
                        <option value="training">ƒêang Hu·∫•n Luy·ªán</option>
                        <option value="review">C·∫ßn Xem X√©t</option>
                        <option value="inactive">Ng·ª´ng Ho·∫°t ƒê·ªông</option>
                    </select>
                    <button id="listViewBtn" class="hidden md:inline-flex h-10 w-10 items-center justify-center rounded-lg border border-slate-200/70 bg-white hover:bg-slate-50"><svg viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M4 5h16v4H4zm0 5h16v4H4zm0 5h16v4H4z"/></svg></button>
                    <button id="gridViewBtn" class="hidden md:inline-flex h-10 w-10 items-center justify-center rounded-lg border border-slate-200/70 bg-white hover:bg-slate-50"><svg viewBox="0 0 24 24" class="h-5 w-5"><path fill="currentColor" d="M4 4h7v7H4zm9 0h7v7h-7zM4 13h7v7H4zm9 0h7v7h-7z"/></svg></button>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="rounded-2xl bg-gem-dark text-white p-5">
                    <div class="text-sm opacity-90">T·ªïng S·∫£n Ph·∫©m</div>
                    <div id="kpiTotal" class="mt-2 text-2xl font-bold">--</div>
                </div>
                <div class="rounded-2xl bg-gem-dark text-white p-5">
                    <div class="text-sm opacity-90">S·∫£n Ph·∫©m Ho·∫°t ƒê·ªông</div>
                    <div id="kpiActive" class="mt-2 text-2xl font-bold">--</div>
                </div>
                <div class="rounded-2xl bg-gem-dark text-white p-5">
                    <div class="text-sm opacity-90">ƒê·ªô Ch√≠nh X√°c TB</div>
                    <div id="kpiAvgAcc" class="mt-2 text-2xl font-bold">--</div>
                </div>
                <div class="rounded-2xl bg-gem-dark text-white p-5">
                    <div class="text-sm opacity-90">C·∫ßn Xem X√©t</div>
                    <div id="kpiReview" class="mt-2 text-2xl font-bold">--</div>
                </div>
            </div>

            <!-- Table -->
            <div class="mt-6 rounded-2xl border border-slate-200/70 bg-white overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-50 text-slate-600">
                        <tr class="text-left">
                            <th class="px-4 py-3 w-10"><input id="selectAll" type="checkbox"/></th>
                            <th class="px-4 py-3">S·∫£n Ph·∫©m</th>
                            <th class="px-4 py-3">Danh M·ª•c</th>
                            <th class="px-4 py-3">M√£ SKU</th>
                            <th class="px-4 py-3">Tr·∫°ng Th√°i</th>
                            <th class="px-4 py-3">ƒê·ªô Ch√≠nh X√°c</th>
                            <th class="px-4 py-3">L·∫ßn Ph√°t Hi·ªán</th>
                            <th class="px-4 py-3">C·∫≠p Nh·∫≠t Cu·ªëi</th>
                            <th class="px-4 py-3">Thao T√°c</th>
                        </tr>
                        </thead>
                        <tbody id="productTbody">
                        <!-- dynamic rows here -->
                        </tbody>
                    </table>
                </div>
                <!-- Table footer -->
                <div class="flex items-center justify-between px-4 py-3 bg-slate-50 text-sm text-slate-600 border-t border-slate-100">
                    <div id="pageInfo">&nbsp;</div>
                    <div class="flex items-center gap-2">
                        <button id="prevBtn" class="px-3 py-1.5 rounded-lg border border-slate-200/70 bg-white hover:bg-slate-50">Tr∆∞·ªõc</button>
                        <button id="nextBtn" class="px-3 py-1.5 rounded-lg border border-slate-200/70 bg-white hover:bg-slate-50">Sau</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Create / Edit Modal -->
<div id="productModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50">
    <div class="w-[95%] max-w-2xl rounded-2xl bg-white shadow-md">
        <div class="px-4 py-3 border-b flex items-center justify-between">
            <h3 id="modalTitle" class="font-semibold">Th√™m S·∫£n Ph·∫©m</h3>
            <button id="closeModalBtn" class="text-slate-500 hover:underline">ƒê√≥ng</button>
        </div>
        <div class="p-4 grid md:grid-cols-2 gap-3 text-sm">
            <input type="hidden" id="productId" />
            <label class="grid gap-1">
                <span>T√™n s·∫£n ph·∫©m</span>
                <input id="fName" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="VD: Coca Cola 500ml"/>
            </label>
            <label class="grid gap-1">
                <span>SKU</span>
                <input id="fSku" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="VD: CC-500-001"/>
            </label>
            <label class="grid gap-1">
                <span>Danh m·ª•c</span>
                <select id="fCategory" class="rounded-lg border border-slate-300 px-3 py-2"></select>
            </label>
            <label class="grid gap-1">
                <span>Tr·∫°ng th√°i</span>
                <select id="fStatus" class="rounded-lg border border-slate-300 px-3 py-2">
                    <option value="active">Ho·∫°t ƒê·ªông</option>
                    <option value="training">ƒêang Hu·∫•n Luy·ªán</option>
                    <option value="review">C·∫ßn Xem X√©t</option>
                    <option value="inactive">Ng·ª´ng Ho·∫°t ƒê·ªông</option>
                </select>
            </label>
            <label class="grid gap-1">
                <span>ƒê·ªô ch√≠nh x√°c (%)</span>
                <input id="fAccuracy" type="number" min="0" max="100" step="0.01" class="rounded-lg border border-slate-300 px-3 py-2"/>
            </label>
            <label class="grid gap-1">
                <span>L·∫ßn ph√°t hi·ªán</span>
                <input id="fDetectCount" type="number" min="0" class="rounded-lg border border-slate-300 px-3 py-2"/>
            </label>
            <label class="grid gap-1 md:col-span-2">
                <span>·∫¢nh (URL)</span>
                <input id="fImage" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="https://..."/>
            </label>
            <label class="grid gap-1 md:col-span-2">
                <span>M√¥ t·∫£</span>
                <textarea id="fDesc" rows="3" class="rounded-lg border border-slate-300 px-3 py-2" placeholder="M√¥ t·∫£ ng·∫Øn"></textarea>
            </label>
            <div id="formError" class="md:col-span-2 text-sm text-orange-600 hidden"></div>
        </div>
        <div class="px-4 py-3 border-t flex items-center justify-end gap-2">
            <button id="saveProductBtn" class="px-4 py-2 rounded-lg bg-gem-dark text-white">L∆∞u</button>
        </div>
    </div>
</div>

<script>
(function() {
  const API_BASE = '/api';
  const ENDPOINTS = {
    products: `${API_BASE}/products/`,
    productDetail: (id) => `${API_BASE}/products/${id}/`,
    restore: (id) => `${API_BASE}/products/${id}/restore/`,
    metrics: `${API_BASE}/products/metrics/`,
    export: `${API_BASE}/products/export/`,
    categories: `${API_BASE}/categories/`,
    categoryDetail: (id) => `${API_BASE}/categories/${id}/`,
  };
  const fmt = new Intl.NumberFormat('vi-VN');
  const $ = (sel) => document.querySelector(sel);

  const tbody = $('#productTbody');
  const searchInput = $('#searchInput');
  const statusFilter = $('#statusFilter');
  const categoryFilter = $('#categoryFilter');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');
  const pageInfo = $('#pageInfo');
  const kpiTotal = $('#kpiTotal');
  const kpiActive = $('#kpiActive');
  const kpiAvgAcc = $('#kpiAvgAcc');
  const kpiReview = $('#kpiReview');
  const openCreateBtn = $('#openCreateBtn');
  const productModal = $('#productModal');
  const closeModalBtn = $('#closeModalBtn');
  const modalTitle = $('#modalTitle');
  const saveProductBtn = $('#saveProductBtn');
  const exportBtn = $('#exportBtn');

  const fId = $('#productId');
  const fName = $('#fName');
  const fSku = $('#fSku');
  const fCategory = $('#fCategory');
  const fStatus = $('#fStatus');
  const fAccuracy = $('#fAccuracy');
  const fDetectCount = $('#fDetectCount');
  const fImage = $('#fImage');
  const fDesc = $('#fDesc');
  const formError = $('#formError');

  const state = { page: 1, page_size: 10, search: '', status: '', category: '' };

  function getCSRFToken() {
    const name = 'csrftoken=';
    const parts = document.cookie.split(';');
    for (let p of parts) {
      p = p.trim();
      if (p.startsWith(name)) return decodeURIComponent(p.slice(name.length));
    }
    return '';
  }

  async function fetchJSON(url, options={}) {
    const opts = { headers: { 'Accept': 'application/json' }, ...options };
    const method = (opts.method || 'GET').toUpperCase();
    if (method !== 'GET') {
      opts.headers = { ...opts.headers, 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() };
      opts.credentials = 'same-origin';
    }
    const res = await fetch(url, opts);
    if (!res.ok) {
      let tx = '';
      try { tx = await res.text(); } catch (_) { tx = res.statusText; }
      throw new Error(tx || res.statusText);
    }
    const ct = res.headers.get('content-type') || '';
    return ct.includes('application/json') ? res.json() : null;
  }

  function statusBadge(s) {
    if (s === 'active') return '<span class="inline-flex items-center rounded-full bg-blue-100 text-blue-700 px-2.5 py-1 text-xs font-medium">Ho·∫°t ƒê·ªông</span>';
    if (s === 'training') return '<span class="inline-flex items-center rounded-full bg-indigo-700 text-white px-2.5 py-1 text-xs font-medium">ƒêang Hu·∫•n Luy·ªán</span>';
    if (s === 'review') return '<span class="inline-flex items-center rounded-full bg-orange-600 text-white px-2.5 py-1 text-xs font-medium">C·∫ßn Xem X√©t</span>';
    if (s === 'inactive') return '<span class="inline-flex items-center rounded-full bg-slate-200 text-slate-700 px-2.5 py-1 text-xs font-medium">Ng·ª´ng</span>';
    return s;
  }

  function timeAgo(iso) {
    if (!iso) return '-';
    const t = new Date(iso);
    const delta = Math.max(1, Math.floor((Date.now() - t.getTime()) / 1000));
    const m = Math.floor(delta/60), h = Math.floor(m/60), d = Math.floor(h/24);
    if (d > 0) return `${d} ng√†y tr∆∞·ªõc`;
    if (h > 0) return `${h} gi·ªù tr∆∞·ªõc`;
    if (m > 0) return `${m} ph√∫t tr∆∞·ªõc`;
    return 'v·ª´a xong';
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
  }

  function rowHTML(p) {
    const acc = (p.accuracy_rate != null) ? `${Number(p.accuracy_rate).toFixed(1)}%` : '-';
    const det = fmt.format(p.detection_count || 0);
    const last = timeAgo(p.last_detected_at);
    const cat = p.category_name || '';
    const img = '<div class="h-10 w-10 rounded-lg bg-slate-200 grid place-content-center text-[10px] text-slate-500">IMG</div>';
    return `
      <tr class="border-t border-slate-100">
        <td class="px-4 py-4 align-top"><input type="checkbox"/></td>
        <td class="px-4 py-4">
          <div class="flex items-center gap-3">
            ${img}
            <div>
              <div class="font-medium">${escapeHtml(p.name)}</div>
              <div class="text-xs text-slate-500">${escapeHtml(p.description || '')}</div>
            </div>
          </div>
        </td>
        <td class="px-4 py-4">${escapeHtml(cat)}</td>
        <td class="px-4 py-4">${escapeHtml(p.sku)}</td>
        <td class="px-4 py-4">${statusBadge(p.status)}</td>
        <td class="px-4 py-4">${acc}</td>
        <td class="px-4 py-4">${det}</td>
        <td class="px-4 py-4">${timeAgo(p.last_updated_at)}</td>
        <td class="px-4 py-4">
          <div class="flex items-center gap-3 text-slate-500">
            <button class="hover:text-gem-dark" title="Xem" data-action="view" data-id="${p.id}">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c7 0 10 7 10 7s-3 7-10 7S2 12 2 12s3-7 10-7Zm0 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"/></svg>
            </button>
            <button class="hover:text-orange-600" title="S·ª≠a" data-action="edit" data-id="${p.id}">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm14.71-9.04a1.003 1.003 0 0 0 0-1.42l-2.5-2.5a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.99-1.66Z"/></svg>
            </button>
            <button class="hover:text-red-600" title="X√≥a" data-action="delete" data-id="${p.id}">
              <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12ZM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4Z"/></svg>
            </button>
          </div>
        </td>
      </tr>`;
  }

  async function loadMetrics() {
    try {
      const data = await fetchJSON(ENDPOINTS.metrics);
      kpiTotal.textContent = fmt.format(data.total_products || 0);
      kpiActive.textContent = fmt.format(data.active_products || 0);
      kpiAvgAcc.textContent = (data.avg_accuracy_rate != null ? Number(data.avg_accuracy_rate).toFixed(1) + '%' : '--');
      kpiReview.textContent = fmt.format(data.review_count || 0);
    } catch (e) { console.warn('metrics', e); }
  }

  async function loadCategories() {
    try {
      const data = await fetchJSON(`${ENDPOINTS.categories}?page_size=100`);
      const items = data.results || data;
      categoryFilter.innerHTML = '<option value="">T·∫•t C·∫£ Danh M·ª•c</option>' + items.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
      fCategory.innerHTML = items.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
    } catch (e) { console.warn('categories', e); }
  }

  function buildQuery() {
    const q = new URLSearchParams();
    if (state.search) q.set('search', state.search);
    if (state.status) q.set('status', state.status);
    if (state.category) q.set('category', state.category);
    q.set('page', state.page);
    q.set('page_size', state.page_size);
    q.set('ordering', '-last_updated_at');
    return q.toString();
  }

  async function loadProducts() {
    const url = `${ENDPOINTS.products}?${buildQuery()}`;
    tbody.innerHTML = `<tr><td colspan="9" class="px-4 py-6 text-center text-slate-500">ƒêang t·∫£i...</td></tr>`;
    try {
      const data = await fetchJSON(url);
      const items = data.results || [];
      if (!items.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="px-4 py-6 text-center text-slate-500">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
      } else {
        tbody.innerHTML = items.map(rowHTML).join('');
      }
      const count = data.count ?? items.length;
      const start = (state.page - 1) * state.page_size + 1;
      const end = Math.min(state.page * state.page_size, count);
      pageInfo.textContent = `Hi·ªÉn th·ªã ${start} ƒë·∫øn ${end} c·ªßa ${fmt.format(count)} s·∫£n ph·∫©m`;
      prevBtn.disabled = !data.previous;
      nextBtn.disabled = !data.next;
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="9" class="px-4 py-6 text-center text-orange-600">L·ªói t·∫£i d·ªØ li·ªáu: ${escapeHtml(e.message)}</td></tr>`;
      pageInfo.textContent = '';
    }
  }

  function openModal(mode, product) {
    productModal.classList.remove('hidden');
    productModal.classList.add('flex');
    formError.classList.add('hidden');
    formError.textContent = '';
    modalTitle.textContent = mode === 'create' ? 'Th√™m S·∫£n Ph·∫©m' : 'C·∫≠p Nh·∫≠t S·∫£n Ph·∫©m';
    if (mode === 'create') {
      fId.value = '';
      fName.value = '';
      fSku.value = '';
      fCategory.value = categoryFilter.value || '';
      fStatus.value = 'active';
      fAccuracy.value = '';
      fDetectCount.value = '';
      fImage.value = '';
      fDesc.value = '';
    } else if (product) {
      fId.value = product.id;
      fName.value = product.name || '';
      fSku.value = product.sku || '';
      fCategory.value = product.category || '';
      fStatus.value = product.status || 'active';
      fAccuracy.value = product.accuracy_rate ?? '';
      fDetectCount.value = product.detection_count ?? '';
      fImage.value = product.image_url || '';
      fDesc.value = product.description || '';
    }
  }

  function closeModal() {
    productModal.classList.add('hidden');
    productModal.classList.remove('flex');
  }

  async function saveProduct() {
    const payload = {
      name: fName.value.trim(),
      sku: fSku.value.trim(),
      category: fCategory.value || null,
      status: fStatus.value,
      accuracy_rate: fAccuracy.value ? Number(fAccuracy.value) : null,
      detection_count: fDetectCount.value ? Number(fDetectCount.value) : 0,
      image_url: fImage.value.trim() || null,
      description: fDesc.value.trim() || null,
    };
    try {
      let url = ENDPOINTS.products;
      let method = 'POST';
      if (fId.value) { url = ENDPOINTS.productDetail(fId.value); method = 'PATCH'; }
      await fetchJSON(url, { method, body: JSON.stringify(payload) });
      closeModal();
      await Promise.all([loadMetrics(), loadProducts()]);
    } catch (e) {
      formError.textContent = 'L·ªói l∆∞u s·∫£n ph·∫©m: ' + (e.message || '');
      formError.classList.remove('hidden');
    }
  }

  async function handleRowAction(e) {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    if (action === 'edit' || action === 'view') {
      try {
        const p = await fetchJSON(ENDPOINTS.productDetail(id));
        openModal('edit', p);
      } catch (err) { alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c s·∫£n ph·∫©m: ' + err.message); }
    } else if (action === 'delete') {
      if (!confirm('X√°c nh·∫≠n x√≥a m·ªÅm s·∫£n ph·∫©m n√†y?')) return;
      try {
        await fetchJSON(ENDPOINTS.productDetail(id), { method: 'DELETE' });
        await Promise.all([loadMetrics(), loadProducts()]);
      } catch (err) { alert('X√≥a th·∫•t b·∫°i: ' + err.message); }
    }
  }

  // Events
  let searchTimer;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { state.search = searchInput.value.trim(); state.page = 1; loadProducts(); }, 300);
  });
  statusFilter.addEventListener('change', () => { state.status = statusFilter.value; state.page = 1; loadProducts(); });
  categoryFilter.addEventListener('change', () => { state.category = categoryFilter.value; state.page = 1; loadProducts(); });
  prevBtn.addEventListener('click', () => { if (state.page > 1) { state.page--; loadProducts(); }});
  nextBtn.addEventListener('click', () => { state.page++; loadProducts(); });
  tbody.addEventListener('click', handleRowAction);
  openCreateBtn.addEventListener('click', () => openModal('create'));
  closeModalBtn.addEventListener('click', closeModal);
  saveProductBtn.addEventListener('click', saveProduct);
  if (exportBtn) {
    exportBtn.addEventListener('click', () => {
      const url = `${ENDPOINTS.export}?${buildQuery()}`;
      window.location = url;
    });
  }

  // Init
  (async function init() {
    await loadCategories();
    await loadMetrics();
    await loadProducts();
  })();
})();
</script>
</body>
</html>
